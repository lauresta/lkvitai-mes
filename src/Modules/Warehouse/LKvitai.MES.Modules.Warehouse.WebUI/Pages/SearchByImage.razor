@page "/search-by-image"
@inject MasterDataAdminClient AdminClient
@inject NavigationManager NavigationManager
@inject ToastService ToastService

<PageTitle>Search by Image - LKvitai.MES</PageTitle>

<h3 class="text-center mb-4">Search by Image</h3>

@if (_apiError is not null)
{
    <ErrorBanner Message="@BuildErrorMessage(_apiError)"
                 TraceId="@_apiError.TraceId"
                 OnRetry="SearchAsync"
                 OnDismiss="@(() => _apiError = null)" />
}

<div class="d-flex justify-content-center mb-3">
    <div class="card shadow-sm position-relative" style="width:100%;max-width:480px;">
        <div class="card-body d-flex flex-column align-items-center justify-content-center py-5">

            @* Keep the InputFile ALWAYS in the DOM — never conditionally remove it.
               Removing it during its own OnChange event crashes the Blazor Server circuit
               with "exception invoking NotifyChange". *@
            <div style="position:relative;width:140px;height:140px;">
                <div style="width:140px;height:140px;border-radius:50%;
                            background:@(_isLoading ? "#6c8ebf" : "#0d6efd");
                            display:flex;align-items:center;justify-content:center;
                            box-shadow:0 4px 16px rgba(13,110,253,.35);
                            transition:background .2s;">
                    @if (_isLoading)
                    {
                        <div class="spinner-border text-white" style="width:2.5rem;height:2.5rem;" role="status">
                            <span class="visually-hidden">Identifying…</span>
                        </div>
                    }
                    else
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="white" viewBox="0 0 16 16">
                            <path d="M15 12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1.172a3 3 0 0 0 2.12-.879l.83-.828A1 1 0 0 1 6.827 3h2.344a1 1 0 0 1 .707.293l.828.828A3 3 0 0 0 12.828 5H14a1 1 0 0 1 1 1zM2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4z" />
                            <path d="M8 11a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5m0 1a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7M3 6.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0" />
                        </svg>
                    }
                </div>
                <InputFile OnChange="HandleFileAsync"
                           accept="image/*"
                           disabled="@_isLoading"
                           style="@_fileInputStyle"
                           @attributes="_captureAttributes" />
            </div>

            <p class="text-muted mt-3 mb-0 text-center">
                @(_isLoading ? "Identifying item…" : "Tap to take a photo or choose from gallery")
            </p>

        </div>
    </div>
</div>

@if (_searched && !_isLoading)
{
    @if (_results.Count == 0)
    {
        <div class="text-center text-muted py-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="mb-3 opacity-50" viewBox="0 0 16 16">
                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0" />
            </svg>
            <p class="mb-0">No matching items found.</p>
            <p class="small">Try uploading a clearer photo, or add photos to items first.</p>
        </div>
    }
    else
    {
        <div class="row g-3">
            @foreach (var result in _results)
            {
                <div class="col-6 col-md-4 col-lg-3">
                    <div class="card h-100" style="cursor:pointer;" @onclick="@(() => OpenItem(result.ItemId))">
                        @if (!string.IsNullOrWhiteSpace(result.PrimaryThumbnailUrl))
                        {
                            <img src="@result.PrimaryThumbnailUrl" alt="@result.SKU" loading="lazy" style="height:150px;object-fit:cover;" />
                        }
                        else
                        {
                            <div class="bg-light border text-muted d-flex align-items-center justify-content-center" style="height:150px;">No image</div>
                        }
                        <div class="card-body">
                            <div><strong>@result.SKU</strong></div>
                            <div class="small text-muted">@result.Name</div>
                            <div class="small">
                                @{
                                    var pct = (int)(result.Score * 100);
                                    var badgeClass = result.Score >= 0.85 ? "bg-success" : result.Score >= 0.65 ? "bg-warning text-dark" : "bg-secondary";
                                }
                                <span class="badge @badgeClass">@pct%</span>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
}

@code {
    private readonly List<ImageSearchResultDto> _results = [];
    private bool _isLoading;
    private bool _searched;
    private ApiException? _apiError;
    private IBrowserFile? _lastFile;
    private readonly Dictionary<string, object> _captureAttributes = new()
    {
        ["capture"] = "environment"
    };

    private string _fileInputStyle =>
        _isLoading
            ? "position:absolute;inset:0;opacity:0;width:100%;height:100%;border-radius:50%;cursor:not-allowed;pointer-events:none;"
            : "position:absolute;inset:0;opacity:0;width:100%;height:100%;border-radius:50%;cursor:pointer;";

    private async Task HandleFileAsync(InputFileChangeEventArgs args)
    {
        _lastFile = args.File;
        await SearchAsync();
    }

    private async Task SearchAsync()
    {
        if (_lastFile is null)
        {
            return;
        }

        _isLoading = true;
        _apiError = null;
        _results.Clear();
        _searched = false;
        // Do NOT call StateHasChanged() here — the InputFile must stay in DOM
        // throughout its own event handling cycle or the Blazor Server circuit crashes
        // with "exception invoking NotifyChange". Blazor re-renders at the next await.

        try
        {
            await using var stream = _lastFile.OpenReadStream(5L * 1024 * 1024);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);

            var response = await AdminClient.SearchByImageAsync(_lastFile.Name, ms.ToArray(), _lastFile.ContentType);
            _results.AddRange(response.Results.OrderByDescending(x => x.Score));
            _searched = true;

            var best = _results.FirstOrDefault();
            if (best is not null && best.Score >= 0.85d)
            {
                OpenItem(best.ItemId);
            }
        }
        catch (ApiException ex)
        {
            _apiError = ex;
            ToastService.ShowError(BuildErrorMessage(ex));
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void OpenItem(int itemId)
    {
        NavigationManager.NavigateTo($"/admin/items/{itemId}");
    }

    private static string BuildErrorMessage(ApiException error)
    {
        if (!string.IsNullOrWhiteSpace(error.ProblemDetails?.Detail))
        {
            return $"{error.UserMessage} {error.ProblemDetails.Detail}";
        }

        return error.UserMessage;
    }
}
