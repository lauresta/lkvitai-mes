@page "/available-stock"
@implements IDisposable
@inject StockClient StockApiClient

<PageTitle>Available Stock - LKvitai.MES</PageTitle>

<div data-testid="stock-page">
<h3>Available Stock</h3>

<StockFilters Warehouses="@_warehouses"
              Filters="@_filters"
              OnSearch="HandleSearchAsync" />

@if (_apiError is not null)
{
    <div data-testid="stock-error">
        <ErrorBanner Message="@BuildErrorMessage(_apiError)"
                     TraceId="@_apiError.TraceId"
                     OnRetry="RetryAsync"
                     OnDismiss="DismissError" />
    </div>
}

<div class="card shadow-sm position-relative">
    <LoadingSpinner IsLoading="@(_isLoadingWarehouses || _isSearching)" />

    <div class="card-body">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
            <div class="text-muted" data-testid="stock-summary">
                @_summaryText
            </div>
            <div class="d-flex flex-wrap gap-2 align-items-center">
                <div class="btn-group" role="group" aria-label="View mode">
                    <button class="btn btn-sm @(GetModeClass(StockViewMode.Table))" @onclick="@(() => SetMode(StockViewMode.Table))">Table</button>
                    <button class="btn btn-sm @(GetModeClass(StockViewMode.List))" @onclick="@(() => SetMode(StockViewMode.List))">List</button>
                    <button class="btn btn-sm @(GetModeClass(StockViewMode.Gallery))" @onclick="@(() => SetMode(StockViewMode.Gallery))">Gallery</button>
                </div>
                <label class="form-label mb-0 text-muted small" for="stock-page-size-select">Page size</label>
                <select id="stock-page-size-select"
                        class="form-select form-select-sm"
                        style="width: 110px;"
                        data-testid="stock-page-size"
                        value="@_pageSize"
                        @onchange="OnPageSizeChangedFromChangeEventAsync">
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
                <button class="btn btn-outline-secondary btn-sm"
                        data-testid="stock-refresh"
                        @onclick="RefreshAsync"
                        disabled="@(_isLoadingWarehouses || _isSearching)">
                    Refresh
                </button>
                <button class="btn btn-outline-secondary btn-sm"
                        data-testid="stock-export"
                        @onclick="ExportCsvAsync"
                        disabled="@(_items.Count == 0)">
                    Export CSV
                </button>
            </div>
        </div>

        @if (!_hasSearched)
        {
            <p class="text-muted mb-0" data-testid="stock-before-search">Enter at least one filter and click Search.</p>
        }
        else
        {
            @if (_viewMode == StockViewMode.Table)
            {
                <MudDataGrid T="AvailableStockItemDto"
                             Items="_items"
                             Filterable="false"
                             SortMode="SortMode.None"
                             Dense="true"
                             Hover="true"
                             Loading="@_isSearching"
                             @attributes="@StockGridAttributes">
                    <NoRecordsContent>
                        <p class="text-muted mb-0 py-2">No stock found matching filters.</p>
                    </NoRecordsContent>
                    <Columns>
                        <TemplateColumn Title="">
                            <CellTemplate>
                                @if (!string.IsNullOrWhiteSpace(context.Item.PrimaryThumbnailUrl))
                                {
                                    <img src="@context.Item.PrimaryThumbnailUrl" alt="@context.Item.SKU" loading="lazy" style="width:48px;height:48px;object-fit:cover;border-radius:4px;" />
                                }
                                else
                                {
                                    <div class="bg-light border text-muted d-flex align-items-center justify-content-center" style="width:48px;height:48px;border-radius:4px;">-</div>
                                }
                            </CellTemplate>
                        </TemplateColumn>
                        <PropertyColumn Property="x => x.WarehouseId" Title="Warehouse" />
                        <PropertyColumn Property="x => x.Location" Title="Location" />
                        <PropertyColumn Property="x => x.SKU" Title="SKU" />
                        <PropertyColumn Property="x => x.ItemName" Title="Name" />
                        <PropertyColumn Property="x => x.PhysicalQty" Title="Physical Qty" />
                        <PropertyColumn Property="x => x.ReservedQty" Title="Reserved Qty" />
                        <PropertyColumn Property="x => x.AvailableQty" Title="Available Qty" />
                        <TemplateColumn Title="Last Updated">
                            <CellTemplate>
                                @context.Item.LastUpdated.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
                                <span class="ms-2"><StaleBadge LastUpdated="context.Item.LastUpdated" /></span>
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>
                </MudDataGrid>
            }
            else if (_viewMode == StockViewMode.List)
            {
                <div class="d-flex flex-column gap-2">
                    @foreach (var row in _items)
                    {
                        <div class="border rounded p-2 d-flex align-items-center gap-3">
                            @if (!string.IsNullOrWhiteSpace(row.PrimaryThumbnailUrl))
                            {
                                <img src="@row.PrimaryThumbnailUrl" alt="@row.SKU" loading="lazy" style="width:64px;height:64px;object-fit:cover;border-radius:4px;" />
                            }
                            else
                            {
                                <div class="bg-light border text-muted d-flex align-items-center justify-content-center" style="width:64px;height:64px;border-radius:4px;">-</div>
                            }
                            <div class="flex-grow-1">
                                <div><strong>@row.SKU</strong> - @row.ItemName</div>
                                <div class="small text-muted">@row.WarehouseId / @row.Location</div>
                            </div>
                            <div class="text-end">
                                <div>On hand: @row.PhysicalQty</div>
                                <div>Available: @row.AvailableQty</div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="row g-3">
                    @foreach (var row in _items)
                    {
                        <div class="col-6 col-md-4 col-lg-3">
                            <div class="card h-100">
                                @if (!string.IsNullOrWhiteSpace(row.PrimaryThumbnailUrl))
                                {
                                    <img src="@row.PrimaryThumbnailUrl" alt="@row.SKU" loading="lazy" style="height:150px;object-fit:cover;" />
                                }
                                else
                                {
                                    <div class="bg-light border text-muted d-flex align-items-center justify-content-center" style="height:150px;">No image</div>
                                }
                                <div class="card-body">
                                    <div><strong>@row.SKU</strong></div>
                                    <div class="small text-muted mb-2">@row.ItemName</div>
                                    <div class="small">@row.WarehouseId / @row.Location</div>
                                    <div class="small">On hand: @row.PhysicalQty</div>
                                    <div class="small">Available: @row.AvailableQty</div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }

            <div class="mt-3">
                <Pagination CurrentPage="@_page"
                            TotalPages="@_totalPages"
                            PageSize="@_pageSize"
                            OnPageChanged="OnPageChangedAsync"
                            OnPageSizeChanged="OnPageSizeChangedAsync" />
            </div>
        }
    </div>
</div>
</div>

@code {
    private IReadOnlyList<WarehouseDto> _warehouses = Array.Empty<WarehouseDto>();
    private IReadOnlyList<AvailableStockItemDto> _items = Array.Empty<AvailableStockItemDto>();
    private AvailableStockSearchFilters _filters = new();

    private bool _isLoadingWarehouses = true;
    private bool _isSearching;
    private bool _hasSearched;

    private int _page = 1;
    private int _pageSize = 50;
    private int _totalCount;

    private ApiException? _apiError;
    private bool _isDisposed;
    private readonly CancellationTokenSource _disposeCts = new();
    private static readonly Dictionary<string, object> StockGridAttributes = new() { ["data-testid"] = "stock-grid" };

    private StockViewMode _viewMode = StockViewMode.Table;
    private int _totalPages => Math.Max(1, (int)Math.Ceiling(_totalCount / (double)Math.Max(1, _pageSize)));

    private string _summaryText => _hasSearched
        ? $"Showing {_items.Count} item(s) on page {_page} of {_totalPages}."
        : "Search has not been run yet.";

    protected override async Task OnInitializedAsync()
    {
        await LoadWarehousesAsync();
    }

    public void Dispose()
    {
        if (_isDisposed)
        {
            return;
        }

        _isDisposed = true;
        _disposeCts.Cancel();
        _disposeCts.Dispose();
    }

    private async Task LoadWarehousesAsync()
    {
        if (_isDisposed)
        {
            return;
        }

        _isLoadingWarehouses = true;
        _apiError = null;

        try
        {
            _warehouses = await StockApiClient.GetWarehousesAsync(_disposeCts.Token);
        }
        catch (ApiException ex)
        {
            _apiError = ex;
            _warehouses = Array.Empty<WarehouseDto>();
        }
        finally
        {
            if (!_isDisposed)
            {
                _isLoadingWarehouses = false;
            }
        }
    }

    private async Task HandleSearchAsync(AvailableStockSearchFilters filters)
    {
        if (_isDisposed)
        {
            return;
        }

        _filters = filters;

        if (!_filters.HasAtLeastOneFilter)
        {
            _hasSearched = false;
            _items = Array.Empty<AvailableStockItemDto>();
            _totalCount = 0;
            _apiError = null;
            return;
        }

        _hasSearched = true;
        _page = 1;
        await LoadPageAsync(_page, _pageSize);
    }

    private async Task LoadPageAsync(int page, int pageSize)
    {
        if (_isDisposed || !_filters.HasAtLeastOneFilter)
        {
            return;
        }

        _isSearching = true;
        _apiError = null;
        _hasSearched = true;

        try
        {
            var result = await StockApiClient.SearchAvailableStockAsync(
                _filters.Warehouse,
                _filters.Location,
                _filters.Sku,
                _filters.IncludeVirtual,
                page,
                pageSize,
                _disposeCts.Token);

            _items = result.Items;
            _totalCount = result.TotalCount;
            _page = page;
            _pageSize = pageSize;
        }
        catch (ApiException ex)
        {
            _apiError = ex;
            _items = Array.Empty<AvailableStockItemDto>();
            _totalCount = 0;
        }
        finally
        {
            if (!_isDisposed)
            {
                _isSearching = false;
            }
        }
    }

    private async Task RetryAsync()
    {
        if (_filters.HasAtLeastOneFilter)
        {
            await LoadPageAsync(_page, _pageSize);
            return;
        }

        await LoadWarehousesAsync();
    }

    private async Task RefreshAsync()
    {
        await LoadWarehousesAsync();
        if (_filters.HasAtLeastOneFilter)
        {
            await LoadPageAsync(_page, _pageSize);
        }
    }

    private async Task ExportCsvAsync()
    {
        if (_items.Count == 0)
        {
            return;
        }

        try
        {
            await StockApiClient.ExportAvailableStockCsvAsync(
                _filters.Warehouse,
                _filters.Location,
                _filters.Sku,
                _filters.IncludeVirtual,
                _disposeCts.Token);
        }
        catch (ApiException ex)
        {
            _apiError = ex;
        }
    }

    private async Task OnPageChangedAsync(int page)
    {
        var nextPage = Math.Clamp(page, 1, _totalPages);
        await LoadPageAsync(nextPage, _pageSize);
    }

    private async Task OnPageSizeChangedAsync(int size)
    {
        var normalized = Math.Clamp(size, 1, 1000);
        _pageSize = normalized;
        _page = 1;
        await LoadPageAsync(_page, _pageSize);
    }

    private async Task OnPageSizeChangedFromChangeEventAsync(ChangeEventArgs args)
    {
        if (args.Value is null || !int.TryParse(args.Value.ToString(), out var parsed))
        {
            return;
        }

        await OnPageSizeChangedAsync(parsed);
    }

    private void SetMode(StockViewMode mode)
    {
        _viewMode = mode;
    }

    private string GetModeClass(StockViewMode mode)
        => _viewMode == mode ? "btn-primary" : "btn-outline-primary";

    private static string BuildErrorMessage(ApiException ex)
    {
        if (!string.IsNullOrWhiteSpace(ex.UserMessage))
        {
            return ex.UserMessage;
        }

        return ex.ProblemDetails?.Detail
               ?? ex.ProblemDetails?.Title
               ?? "Stock request failed.";
    }

    private void DismissError()
    {
        _apiError = null;
    }

    private enum StockViewMode
    {
        Table,
        List,
        Gallery
    }
}
