@page "/warehouse/admin/lots"
@inject LotsClient LotsClient
@using System.Diagnostics

<PageTitle>Lots - LKvitai.MES</PageTitle>

<div data-testid="lots-page">
<h3>Lots</h3>

@if (_apiError is not null)
{
    <div data-testid="lots-error">
        <ErrorBanner Message="@BuildErrorMessage(_apiError)"
                     TraceId="@_apiError.TraceId"
                     OnRetry="LoadAsync"
                     OnDismiss="@(() => _apiError = null)" />
    </div>
}

<div class="card shadow-sm mb-3">
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-md-4" data-testid="lots-search">
                <MudTextField T="string"
                              Label="Search"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              @bind-Value="_search"
                              Placeholder="Lot number, SKU, item name"
                              InputAttributes="@LotsFilterSearchAttributes" />
            </div>
            <div class="col-md-3">
                <MudSelect T="string"
                           Label="Status"
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense"
                           @bind-Value="_status"
                           InputAttributes="@LotsFilterStatusAttributes">
                    <MudSelectItem T="string" Value="@string.Empty">All</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Active")">Active</MudSelectItem>
                    <MudSelectItem T="string" Value="@("ExpiringSoon")">Expiring soon</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Expired")">Expired</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Depleted")">Depleted</MudSelectItem>
                </MudSelect>
            </div>
            <div class="col-md-2">
                <MudSelect T="int"
                           Label="Page size"
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense"
                           Value="@_pageSize"
                           ValueChanged="OnPageSizeChangedAsync"
                           InputAttributes="@LotsPageSizeAttributes">
                    <MudSelectItem T="int" Value="25">25</MudSelectItem>
                    <MudSelectItem T="int" Value="50">50</MudSelectItem>
                    <MudSelectItem T="int" Value="100">100</MudSelectItem>
                </MudSelect>
            </div>
            <div class="col-md-3 d-flex gap-2">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="ApplyFiltersAsync"
                           UserAttributes="@LotsSearchButtonAttributes">
                    Filter
                </MudButton>
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           OnClick="RefreshAsync"
                           UserAttributes="@LotsRefreshAttributes">
                    Refresh
                </MudButton>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm position-relative">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <strong data-testid="lots-summary">Total: @_totalCount</strong>
            <span class="text-muted small" data-testid="lots-current-page">Page @_currentPage</span>
        </div>

        <MudDataGrid T="LotListItemDto"
                     @ref="_grid"
                     @key="_gridRenderKey"
                     ServerData="LoadServerDataAsync"
                     Filterable="false"
                     SortMode="SortMode.Single"
                     Dense="true"
                     Hover="true"
                     RowsPerPage="@_pageSize"
                     Loading="@_isLoading"
                     @attributes="@LotsGridAttributes">
            <Columns>
                <PropertyColumn Property="x => x.LotNumber" Title="Lot" />
                <TemplateColumn Title="Item">
                    <CellTemplate>
                        @($"{context.Item.ItemSku} - {context.Item.ItemName}")
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Qty">
                    <CellTemplate>@context.Item.Qty.ToString("0.###")</CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Reserved">
                    <CellTemplate>@context.Item.ReservedQty.ToString("0.###")</CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Available">
                    <CellTemplate>@context.Item.AvailableQty.ToString("0.###")</CellTemplate>
                </TemplateColumn>
                <PropertyColumn Property="x => x.BaseUom" Title="UoM" />
                <TemplateColumn Title="Production">
                    <CellTemplate>@FormatDate(context.Item.ProductionDate)</CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Expiry">
                    <CellTemplate>@FormatDate(context.Item.ExpiryDate)</CellTemplate>
                </TemplateColumn>
                <PropertyColumn Property="x => x.Status" Title="Status" />
            </Columns>
            <NoRecordsContent>
                <MudText Typo="Typo.body2" Class="text-muted">No lots found.</MudText>
            </NoRecordsContent>
            <PagerContent>
                <div data-testid="lots-pager">
                    <MudDataGridPager T="LotListItemDto" />
                </div>
            </PagerContent>
        </MudDataGrid>
    </div>
</div>
</div>

@code {
    private MudDataGrid<LotListItemDto>? _grid;
    private string _search = string.Empty;
    private string _status = string.Empty;
    private string? _appliedSearch;
    private string? _appliedStatus;
    private int _pageSize = 50;
    private int _totalCount;
    private int _currentPage = 1;
    private int _gridRenderKey;
    private bool _isLoading;
    private ApiException? _apiError;

    private static readonly Dictionary<string, object> LotsGridAttributes = new() { ["data-testid"] = "lots-grid" };
    private static readonly Dictionary<string, object> LotsFilterSearchAttributes = new() { ["data-testid"] = "lots-search-input" };
    private static readonly Dictionary<string, object> LotsFilterStatusAttributes = new() { ["data-testid"] = "lots-status" };
    private static readonly Dictionary<string, object> LotsPageSizeAttributes = new() { ["data-testid"] = "lots-page-size" };
    private static readonly Dictionary<string, object> LotsRefreshAttributes = new() { ["data-testid"] = "lots-refresh" };
    private static readonly Dictionary<string, object> LotsSearchButtonAttributes = new() { ["data-testid"] = "lots-search-btn" };

    private async Task ApplyFiltersAsync()
    {
        _appliedSearch = string.IsNullOrWhiteSpace(_search) ? null : _search.Trim();
        _appliedStatus = string.IsNullOrWhiteSpace(_status) ? null : _status;
        _gridRenderKey++;
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnPageSizeChangedAsync(int pageSize)
    {
        _pageSize = Math.Clamp(pageSize, 1, 500);
        _gridRenderKey++;
        await InvokeAsync(StateHasChanged);
    }

    private async Task RefreshAsync()
    {
        if (_grid is null)
        {
            return;
        }

        await _grid.ReloadServerData();
    }

    private Task LoadAsync() => RefreshAsync();

    private async Task<GridData<LotListItemDto>> LoadServerDataAsync(GridState<LotListItemDto> state)
    {
        _isLoading = true;
        _apiError = null;
        _currentPage = state.Page + 1;

        var requestedPageSize = state.PageSize > 0 ? state.PageSize : _pageSize;
        _pageSize = requestedPageSize;

        try
        {
            var result = await LotsClient.GetLotsAsync(_appliedSearch, _appliedStatus, state.Page + 1, requestedPageSize);
            _totalCount = result.TotalCount;

            return new GridData<LotListItemDto>
            {
                Items = result.Items,
                TotalItems = result.TotalCount
            };
        }
        catch (ApiException ex)
        {
            _apiError = ex;
            _totalCount = 0;

            return new GridData<LotListItemDto>
            {
                Items = Array.Empty<LotListItemDto>(),
                TotalItems = 0
            };
        }
        catch (Exception ex)
        {
            _apiError = new ApiException(
                new ProblemDetailsModel
                {
                    Title = "Lots query failed",
                    Detail = ex.Message,
                    Status = 500,
                    TraceId = Activity.Current?.Id
                },
                500);
            _totalCount = 0;

            return new GridData<LotListItemDto>
            {
                Items = Array.Empty<LotListItemDto>(),
                TotalItems = 0
            };
        }
        finally
        {
            _isLoading = false;
        }
    }

    private static string FormatDate(DateOnly? value)
        => value?.ToString("yyyy-MM-dd") ?? "-";

    private static string BuildErrorMessage(ApiException error)
    {
        if (!string.IsNullOrWhiteSpace(error.ProblemDetails?.Detail))
        {
            return $"{error.UserMessage} {error.ProblemDetails.Detail}";
        }

        return error.UserMessage;
    }
}
