@page "/warehouse/agnum/config"
@using System.ComponentModel.DataAnnotations
@using System.Text.RegularExpressions
@using LKvitai.MES.WebUI.Infrastructure
@using LKvitai.MES.WebUI.Models
@inject AgnumClient AgnumClient
@inject MasterDataAdminClient MasterDataAdminClient
@inject ToastService ToastService

<PageTitle>Agnum Configuration</PageTitle>

<h1>Agnum Export Configuration</h1>

@if (_apiError is not null)
{
    <ErrorBanner Message="@BuildErrorMessage(_apiError)"
                 TraceId="@_apiError.TraceId"
                 OnRetry="LoadAsync"
                 OnDismiss="DismissError" />
}

<div class="card shadow-sm position-relative">
    <LoadingSpinner IsLoading="_isLoading || _isSaving || _isTestingConnection" />

    <div class="card-body">
        <EditForm Model="_model" OnValidSubmit="SaveAsync">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="row g-3">
                <div class="col-12 col-md-3">
                    <label class="form-label">Export Scope</label>
                    <InputSelect class="form-select" @bind-Value="_model.Scope">
                        @foreach (var scope in ExportScopes)
                        {
                            <option value="@scope">@scope</option>
                        }
                    </InputSelect>
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label">Schedule (Cron)</label>
                    <InputText class="form-control" @bind-Value="_model.Schedule" />
                    <div class="form-text">Example: 0 23 * * *</div>
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label">Format</label>
                    <InputSelect class="form-select" @bind-Value="_model.Format">
                        @foreach (var format in ExportFormats)
                        {
                            <option value="@format">@format</option>
                        }
                    </InputSelect>
                </div>
                <div class="col-12 col-md-3 d-flex align-items-end">
                    <div class="form-check">
                        <InputCheckbox class="form-check-input" @bind-Value="_model.IsActive" />
                        <label class="form-check-label">Active</label>
                    </div>
                </div>
                <div class="col-12 col-md-8">
                    <label class="form-label">API Endpoint</label>
                    <InputText class="form-control" @bind-Value="_model.ApiEndpoint" />
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label">API Key</label>
                    <input class="form-control" type="password" @bind="_model.ApiKey" />
                </div>
            </div>

            <div class="d-flex flex-wrap gap-2 mt-3">
                <button class="btn btn-outline-secondary" type="button" @onclick="UseDailyPreset">Daily 23:00</button>
                <button class="btn btn-outline-secondary" type="button" @onclick="UseHourlyPreset">Hourly</button>
                <button class="btn btn-outline-secondary" type="button" @onclick="UseWeekdayPreset">Weekdays 08:00</button>
                <button class="btn btn-outline-primary ms-auto" type="button" @onclick="TestConnectionAsync" disabled="@_isTestingConnection">
                    Test Connection
                </button>
            </div>

            <hr />

            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">Mappings</h5>
                <button class="btn btn-sm btn-outline-primary" type="button" @onclick="AddMapping">+ Add Mapping</button>
            </div>

            @if (_mappings.Count == 0)
            {
                <div class="alert alert-light border">
                    No mappings configured. Add your first mapping.
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead>
                        <tr>
                            <th style="width: 25%;">Source Type</th>
                            <th style="width: 35%;">Source Value</th>
                            <th style="width: 30%;">Agnum Account Code</th>
                            <th style="width: 10%;">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        @for (var i = 0; i < _mappings.Count; i++)
                        {
                            var row = _mappings[i];
                            <tr>
                                <td>
                                    <InputSelect class="form-select"
                                                 @bind-Value="row.SourceType"
                                                 @bind-Value:after="@(() => HandleSourceTypeChanged(row))">
                                        @foreach (var sourceType in SourceTypes)
                                        {
                                            <option value="@sourceType">@sourceType</option>
                                        }
                                    </InputSelect>
                                </td>
                                <td>
                                    <InputSelect class="form-select" @bind-Value="row.SourceValue">
                                        @foreach (var value in GetSourceValues(row.SourceType))
                                        {
                                            <option value="@value">@value</option>
                                        }
                                    </InputSelect>
                                </td>
                                <td>
                                    <InputText class="form-control" @bind-Value="row.AgnumAccountCode" />
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger" type="button" @onclick="@(() => RemoveMapping(i))">Remove</button>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            }

            <div class="d-flex justify-content-end mt-3">
                <button class="btn btn-primary" type="submit" disabled="@_isSaving">Save</button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    private static readonly Regex CronRegex =
        new(@"^\s*\S+\s+\S+\s+\S+\s+\S+\s+\S+\s*$", RegexOptions.Compiled);

    private static readonly string[] ExportScopes = ["BY_WAREHOUSE", "BY_CATEGORY", "BY_LOGICAL_WH", "TOTAL_ONLY"];
    private static readonly string[] ExportFormats = ["CSV", "JSON_API"];
    private static readonly string[] SourceTypes = ["WAREHOUSE", "CATEGORY", "LOGICAL_WH", "TOTAL_ONLY"];

    private readonly AgnumConfigFormModel _model = new();
    private readonly List<MappingRowModel> _mappings = [];
    private readonly List<AdminCategoryDto> _categories = [];

    private ApiException? _apiError;
    private bool _isLoading;
    private bool _isSaving;
    private bool _isTestingConnection;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        _isLoading = true;
        _apiError = null;
        try
        {
            _categories.Clear();
            _categories.AddRange(await MasterDataAdminClient.GetCategoriesAsync());

            var config = await AgnumClient.GetConfigAsync();
            if (config is null)
            {
                _mappings.Clear();
                return;
            }

            _model.ConfigId = config.Id;
            _model.Scope = config.Scope.ToUpperInvariant();
            _model.Schedule = config.Schedule;
            _model.Format = config.Format.ToUpperInvariant();
            _model.ApiEndpoint = config.ApiEndpoint;
            _model.ApiKey = string.Empty;
            _model.IsActive = config.IsActive;

            _mappings.Clear();
            foreach (var mapping in config.Mappings)
            {
                _mappings.Add(new MappingRowModel
                {
                    SourceType = mapping.SourceType.ToUpperInvariant(),
                    SourceValue = mapping.SourceValue,
                    AgnumAccountCode = mapping.AgnumAccountCode
                });
            }
        }
        catch (ApiException ex)
        {
            _apiError = ex;
            ToastService.ShowError(BuildErrorMessage(ex));
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SaveAsync()
    {
        _apiError = null;
        if (string.IsNullOrWhiteSpace(_model.Schedule) || !CronRegex.IsMatch(_model.Schedule))
        {
            ToastService.ShowError("Schedule must be a valid cron expression with 5 fields.");
            return;
        }

        if (!string.Equals(_model.Scope, "TOTAL_ONLY", StringComparison.OrdinalIgnoreCase) && _mappings.Count == 0)
        {
            ToastService.ShowError($"At least 1 mapping required for scope {_model.Scope}.");
            return;
        }

        if (_mappings.Any(x =>
                string.IsNullOrWhiteSpace(x.SourceType) ||
                string.IsNullOrWhiteSpace(x.SourceValue) ||
                string.IsNullOrWhiteSpace(x.AgnumAccountCode)))
        {
            ToastService.ShowError("Each mapping requires source type, source value, and account code.");
            return;
        }

        _isSaving = true;
        try
        {
            var response = await AgnumClient.SaveConfigAsync(new PutAgnumConfigRequestDto
            {
                ConfigId = _model.ConfigId,
                Scope = _model.Scope.ToUpperInvariant(),
                Schedule = _model.Schedule.Trim(),
                Format = _model.Format.ToUpperInvariant(),
                ApiEndpoint = string.IsNullOrWhiteSpace(_model.ApiEndpoint) ? null : _model.ApiEndpoint.Trim(),
                ApiKey = string.IsNullOrWhiteSpace(_model.ApiKey) ? null : _model.ApiKey.Trim(),
                IsActive = _model.IsActive,
                Mappings = _mappings.Select(x => new PutAgnumMappingRequestDto
                {
                    SourceType = x.SourceType.ToUpperInvariant(),
                    SourceValue = x.SourceValue.Trim(),
                    AgnumAccountCode = x.AgnumAccountCode.Trim().ToUpperInvariant()
                }).ToList()
            });

            _model.ConfigId = response.Id;
            _model.ApiKey = string.Empty;
            ToastService.ShowSuccess("Agnum configuration saved successfully.");
        }
        catch (ApiException ex)
        {
            _apiError = ex;
            ToastService.ShowError(BuildErrorMessage(ex));
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task TestConnectionAsync()
    {
        _apiError = null;
        _isTestingConnection = true;
        try
        {
            var response = await AgnumClient.TestConnectionAsync(new TestAgnumConnectionRequestDto
            {
                ApiEndpoint = _model.ApiEndpoint,
                ApiKey = _model.ApiKey
            });

            if (response.Success)
            {
                ToastService.ShowSuccess(response.Message);
            }
            else
            {
                ToastService.ShowError(response.Message);
            }
        }
        catch (ApiException ex)
        {
            _apiError = ex;
            ToastService.ShowError(BuildErrorMessage(ex));
        }
        finally
        {
            _isTestingConnection = false;
        }
    }

    private void AddMapping()
    {
        var mapping = new MappingRowModel
        {
            SourceType = ResolveSourceTypeForScope(_model.Scope),
            AgnumAccountCode = string.Empty
        };
        HandleSourceTypeChanged(mapping);
        _mappings.Add(mapping);
    }

    private void RemoveMapping(int index)
    {
        if (index < 0 || index >= _mappings.Count)
        {
            return;
        }

        _mappings.RemoveAt(index);
    }

    private void HandleSourceTypeChanged(MappingRowModel row)
    {
        var sourceValues = GetSourceValues(row.SourceType).ToList();
        if (sourceValues.Count == 0)
        {
            row.SourceValue = string.Empty;
            return;
        }

        if (!sourceValues.Contains(row.SourceValue, StringComparer.OrdinalIgnoreCase))
        {
            row.SourceValue = sourceValues[0];
        }
    }

    private IEnumerable<string> GetSourceValues(string sourceType)
    {
        return sourceType.ToUpperInvariant() switch
        {
            "CATEGORY" => _categories.Count == 0
                ? ["Raw Materials", "Finished Goods"]
                : _categories.Select(x => x.Name),
            "WAREHOUSE" => ["RES", "PROD", "NLQ", "SCRAP"],
            "LOGICAL_WH" => ["RES", "PROD", "NLQ", "SCRAP"],
            "TOTAL_ONLY" => ["TOTAL"],
            _ => Array.Empty<string>()
        };
    }

    private static string ResolveSourceTypeForScope(string scope)
    {
        return scope.ToUpperInvariant() switch
        {
            "BY_WAREHOUSE" => "WAREHOUSE",
            "BY_CATEGORY" => "CATEGORY",
            "BY_LOGICAL_WH" => "LOGICAL_WH",
            "TOTAL_ONLY" => "TOTAL_ONLY",
            _ => "CATEGORY"
        };
    }

    private void UseDailyPreset()
    {
        _model.Schedule = "0 23 * * *";
    }

    private void UseHourlyPreset()
    {
        _model.Schedule = "0 * * * *";
    }

    private void UseWeekdayPreset()
    {
        _model.Schedule = "0 8 * * 1-5";
    }

    private void DismissError()
    {
        _apiError = null;
    }

    private static string BuildErrorMessage(ApiException ex)
    {
        if (!string.IsNullOrWhiteSpace(ex.UserMessage))
        {
            return ex.UserMessage;
        }

        return ex.ProblemDetails?.Detail
               ?? ex.ProblemDetails?.Title
               ?? "Agnum configuration request failed.";
    }

    private sealed class AgnumConfigFormModel
    {
        public Guid? ConfigId { get; set; }

        [Required]
        public string Scope { get; set; } = "BY_CATEGORY";

        [Required]
        public string Schedule { get; set; } = "0 23 * * *";

        [Required]
        public string Format { get; set; } = "CSV";

        [Url]
        public string? ApiEndpoint { get; set; }

        public string? ApiKey { get; set; }

        public bool IsActive { get; set; } = true;
    }

    private sealed class MappingRowModel
    {
        public string SourceType { get; set; } = "CATEGORY";
        public string SourceValue { get; set; } = string.Empty;
        public string AgnumAccountCode { get; set; } = string.Empty;
    }
}
