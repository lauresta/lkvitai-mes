@page "/warehouse/waves"
@inject AdvancedWarehouseClient AdvancedClient
@inject ToastService ToastService
@using LKvitai.MES.Modules.Warehouse.WebUI.Infrastructure

<PageTitle>Wave Picking - LKvitai.MES</PageTitle>

<h3>Wave Picking</h3>

@if (_error is not null)
{
    <ErrorBanner Message="@_error.UserMessage"
                 TraceId="@_error.TraceId"
                 OnRetry="LoadAsync"
                 OnDismiss="DismissError" />
}

<div class="card shadow-sm mb-3">
    <div class="card-body">
        <h5>Create Wave</h5>
        <div class="row g-2 align-items-end">
            <div class="col-md-6">
                <label class="form-label">Order IDs (comma separated GUIDs)</label>
                <input class="form-control" @bind="_orderIdsInput" placeholder="11111111-1111-1111-1111-111111111111,..." />
            </div>
            <div class="col-md-3">
                <label class="form-label">Assigned Operator</label>
                <input class="form-control" @bind="_assignedOperator" placeholder="picker-01" />
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary w-100" @onclick="CreateWaveAsync" disabled="@_isBusy">Create Wave</button>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Active Waves</h5>
            <div class="d-flex gap-2">
                <select class="form-select form-select-sm" style="width: 180px" @bind="_statusFilter" @bind:after="LoadAsync">
                    <option value="">All statuses</option>
                    <option value="CREATED">CREATED</option>
                    <option value="ASSIGNED">ASSIGNED</option>
                    <option value="PICKING">PICKING</option>
                    <option value="COMPLETED">COMPLETED</option>
                </select>
                <button class="btn btn-outline-secondary btn-sm" @onclick="LoadAsync" disabled="@_isBusy">Refresh</button>
            </div>
        </div>

        @if (_waves.Count == 0)
        {
            <EmptyState Title="No waves found"
                        Message="Create a wave to start batch picking."
                        IconCss="bi bi-layers"
                        OnAction="LoadAsync" />
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-sm align-middle">
                    <thead>
                        <tr>
                            <th>Wave</th>
                            <th>Status</th>
                            <th>Operator</th>
                            <th>Orders</th>
                            <th>Progress</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var wave in _waves)
                        {
                            <tr>
                                <td>@wave.WaveNumber</td>
                                <td><span class="badge @GetStatusClass(wave.Status)">@wave.Status</span></td>
                                <td>@(wave.AssignedOperator ?? "-")</td>
                                <td>@wave.OrderIds.Count</td>
                                <td>@wave.CompletedLines/@wave.TotalLines</td>
                                <td class="d-flex gap-1">
                                    @if (wave.Status == "CREATED")
                                    {
                                        <button class="btn btn-sm btn-outline-primary" @onclick="() => AssignAsync(wave.Id)">Assign</button>
                                    }
                                    @if (wave.Status == "ASSIGNED")
                                    {
                                        <button class="btn btn-sm btn-outline-success" @onclick="() => StartAsync(wave.Id)">Start</button>
                                    }
                                    @if (wave.Status is "ASSIGNED" or "PICKING")
                                    {
                                        <button class="btn btn-sm btn-outline-secondary" @onclick="() => CompleteLineAsync(wave.Id)">+1 Line</button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

@code {
    private readonly List<WaveDto> _waves = [];
    private string _orderIdsInput = string.Empty;
    private string _assignedOperator = string.Empty;
    private string _statusFilter = string.Empty;
    private ApiException? _error;
    private bool _isBusy;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        await ExecuteAsync(async () =>
        {
            var rows = await AdvancedClient.GetWavesAsync(_statusFilter);
            _waves.Clear();
            _waves.AddRange(rows.OrderByDescending(x => x.CreatedAt));
        });
    }

    private async Task CreateWaveAsync()
    {
        var orderIds = _orderIdsInput
            .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
            .Select(value => Guid.TryParse(value, out var id) ? id : Guid.Empty)
            .Where(id => id != Guid.Empty)
            .Distinct()
            .ToList();

        if (orderIds.Count == 0)
        {
            ToastService.ShowError("Enter at least one valid order GUID.");
            return;
        }

        await ExecuteAsync(async () =>
        {
            await AdvancedClient.CreateWaveAsync(new WaveCreateRequestDto(orderIds, _assignedOperator));
            _orderIdsInput = string.Empty;
            ToastService.ShowSuccess("Wave created.");
            await LoadAsync();
        });
    }

    private async Task AssignAsync(Guid id)
    {
        var operatorName = string.IsNullOrWhiteSpace(_assignedOperator) ? "picker-01" : _assignedOperator;
        await ExecuteAsync(async () =>
        {
            await AdvancedClient.AssignWaveAsync(id, operatorName);
            ToastService.ShowSuccess("Wave assigned.");
            await LoadAsync();
        });
    }

    private async Task StartAsync(Guid id)
    {
        await ExecuteAsync(async () =>
        {
            await AdvancedClient.StartWaveAsync(id);
            ToastService.ShowSuccess("Wave started.");
            await LoadAsync();
        });
    }

    private async Task CompleteLineAsync(Guid id)
    {
        await ExecuteAsync(async () =>
        {
            await AdvancedClient.CompleteWaveLinesAsync(id, 1);
            await LoadAsync();
        });
    }

    private async Task ExecuteAsync(Func<Task> action)
    {
        _isBusy = true;
        _error = null;

        try
        {
            await action();
        }
        catch (ApiException ex)
        {
            _error = ex;
            ToastService.ShowError(ex.UserMessage);
        }
        finally
        {
            _isBusy = false;
        }
    }

    private void DismissError()
    {
        _error = null;
    }

    private static string GetStatusClass(string status) => status switch
    {
        "COMPLETED" => "bg-success",
        "PICKING" => "bg-primary",
        "ASSIGNED" => "bg-info text-dark",
        _ => "bg-secondary"
    };
}
