@page "/warehouse/labels"
@using System.Text.Json
@using LKvitai.MES.Modules.Warehouse.WebUI.Infrastructure
@using LKvitai.MES.Modules.Warehouse.WebUI.Models
@inject LabelsClient LabelsClient
@inject ToastService ToastService
@inject IJSRuntime JS

<PageTitle>Labels</PageTitle>

<h1>Labels Station</h1>

@if (_apiError is not null)
{
    <ErrorBanner Message="@BuildErrorMessage(_apiError)" TraceId="@_apiError.TraceId" OnRetry="LoadAsync" OnDismiss="DismissError" />
}

<div class="row g-3">
    <div class="col-12 col-xl-5">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h5>Print / Preview</h5>
                <div class="mb-2">
                    <label class="form-label">Template</label>
                    <select class="form-select" @bind="_templateType">
                        <option value="">Select template</option>
                        @foreach (var template in _templates)
                        {
                            <option value="@template.TemplateType">@template.TemplateType</option>
                        }
                    </select>
                </div>
                <div class="mb-2">
                    <label class="form-label">Data (JSON object)</label>
                    <textarea class="form-control" rows="8" @bind="_dataJson"></textarea>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" @onclick="PrintAsync" disabled="@_isSubmitting">Print</button>
                    <button class="btn btn-outline-secondary" @onclick="PreviewAsync" disabled="@_isSubmitting">Preview PDF</button>
                </div>
                <div class="row g-2 mt-2">
                    <div class="col-9">
                        <input class="form-control form-control-sm" @bind="_pdfFileName" placeholder="PDF file name from print result" />
                    </div>
                    <div class="col-3">
                        <button class="btn btn-sm btn-outline-primary w-100" @onclick="DownloadPdfAsync" disabled="@_isSubmitting">Get PDF</button>
                    </div>
                </div>
                @if (!string.IsNullOrWhiteSpace(_lastPrintStatus))
                {
                    <div class="alert alert-info mt-3 mb-0">@_lastPrintStatus</div>
                }
            </div>
        </div>
    </div>

    <div class="col-12 col-xl-7">
        <div class="card shadow-sm h-100 position-relative">
            <LoadingSpinner IsLoading="_isLoading" />
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">Queue</h5>
                    <button class="btn btn-sm btn-outline-secondary" @onclick="LoadAsync">Refresh</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Id</th>
                                <th>Template</th>
                                <th>Status</th>
                                <th>Retries</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (_queue.Count == 0)
                            {
                                <tr><td colspan="5">Queue is empty.</td></tr>
                            }
                            else
                            {
                                @foreach (var row in _queue)
                                {
                                    <tr>
                                        <td class="small">@row.Id</td>
                                        <td>@row.TemplateType</td>
                                        <td>@row.Status</td>
                                        <td>@row.RetryCount</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary" @onclick="() => RetryAsync(row.Id)">Retry</button>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private readonly List<LabelTemplateDto> _templates = [];
    private readonly List<LabelQueueItemDto> _queue = [];
    private ApiException? _apiError;
    private bool _isLoading;
    private bool _isSubmitting;

    private string _templateType = string.Empty;
    private string _dataJson = "{\n  \"sku\": \"SKU-001\",\n  \"qty\": \"1\"\n}";
    private string _pdfFileName = string.Empty;
    private string? _lastPrintStatus;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        _isLoading = true;
        _apiError = null;

        try
        {
            var templates = await LabelsClient.GetTemplatesAsync();
            _templates.Clear();
            _templates.AddRange(templates.OrderBy(x => x.TemplateType, StringComparer.OrdinalIgnoreCase));

            if (string.IsNullOrWhiteSpace(_templateType) && _templates.Count > 0)
            {
                _templateType = _templates[0].TemplateType;
            }

            var queue = await LabelsClient.GetQueueAsync();
            _queue.Clear();
            _queue.AddRange(queue.OrderByDescending(x => x.CreatedAt));
        }
        catch (ApiException ex)
        {
            _apiError = ex;
            ToastService.ShowError(BuildErrorMessage(ex));
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task PrintAsync()
    {
        var data = ParseData();
        if (data is null)
        {
            return;
        }

        _isSubmitting = true;
        _lastPrintStatus = null;
        try
        {
            var response = await LabelsClient.PrintAsync(new LabelPrintRequestDto(_templateType, data));
            _lastPrintStatus = $"Status: {response.Status}. {response.Message}";
            ToastService.ShowSuccess("Print request submitted.");
            await LoadAsync();
        }
        catch (ApiException ex)
        {
            _apiError = ex;
            ToastService.ShowError(BuildErrorMessage(ex));
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private async Task PreviewAsync()
    {
        var data = ParseData();
        if (data is null)
        {
            return;
        }

        _isSubmitting = true;
        try
        {
            var bytes = await LabelsClient.PreviewAsync(new LabelPreviewRequestDto(_templateType, data));
            await JS.InvokeVoidAsync("csvExport.downloadBytes", $"label-preview-{DateTime.UtcNow:yyyyMMddHHmmss}.pdf", "application/pdf", Convert.ToBase64String(bytes));
        }
        catch (ApiException ex)
        {
            _apiError = ex;
            ToastService.ShowError(BuildErrorMessage(ex));
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private async Task RetryAsync(Guid id)
    {
        try
        {
            await LabelsClient.RetryAsync(id);
            ToastService.ShowSuccess("Queue retry submitted.");
            await LoadAsync();
        }
        catch (ApiException ex)
        {
            _apiError = ex;
            ToastService.ShowError(BuildErrorMessage(ex));
        }
    }

    private async Task DownloadPdfAsync()
    {
        if (string.IsNullOrWhiteSpace(_pdfFileName))
        {
            ToastService.ShowError("PDF file name is required.");
            return;
        }

        _isSubmitting = true;
        try
        {
            var bytes = await LabelsClient.GetPdfAsync(_pdfFileName.Trim());
            await JS.InvokeVoidAsync("csvExport.downloadBytes", _pdfFileName.Trim(), "application/pdf", Convert.ToBase64String(bytes));
        }
        catch (ApiException ex)
        {
            _apiError = ex;
            ToastService.ShowError(BuildErrorMessage(ex));
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private Dictionary<string, string>? ParseData()
    {
        if (string.IsNullOrWhiteSpace(_templateType))
        {
            ToastService.ShowError("Template is required.");
            return null;
        }

        try
        {
            var json = JsonDocument.Parse(_dataJson);
            if (json.RootElement.ValueKind != JsonValueKind.Object)
            {
                ToastService.ShowError("Data JSON must be an object.");
                return null;
            }

            var result = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
            foreach (var property in json.RootElement.EnumerateObject())
            {
                result[property.Name] = property.Value.ValueKind == JsonValueKind.String
                    ? property.Value.GetString() ?? string.Empty
                    : property.Value.GetRawText();
            }

            return result;
        }
        catch
        {
            ToastService.ShowError("Invalid data JSON.");
            return null;
        }
    }

    private void DismissError() => _apiError = null;

    private static string BuildErrorMessage(ApiException ex)
        => ex.UserMessage
           ?? ex.ProblemDetails?.Detail
           ?? ex.ProblemDetails?.Title
           ?? "Labels request failed.";
}
