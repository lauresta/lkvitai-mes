@page "/warehouse/cycle-counts/{Id:guid}/execute"
@inject CycleCountsClient CycleCountsClient
@inject NavigationManager NavigationManager
@inject ToastService ToastService

<PageTitle>Execute Cycle Count - LKvitai.MES</PageTitle>

<h1>Execute Cycle Count</h1>

<div class="card shadow-sm position-relative">
    <LoadingSpinner IsLoading="_isLoading || _isSubmitting" />
    <div class="card-body">
        @if (_cycleCount is null)
        {
            <EmptyState Title="Cycle count not found."
                        Message="The selected cycle count is unavailable."
                        IconCss="bi bi-clipboard-x"
                        OnAction="BackAsync" />
        }
        else
        {
            <div class="mb-3">
                <div><strong>@_cycleCount.CountNumber</strong></div>
                <div class="text-muted">Progress: @CountedLocations of @TotalLocations locations counted</div>
            </div>

            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Location Barcode</label>
                    <input class="form-control" @bind="_locationCode" placeholder="R1-C1-L1" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Item Barcode</label>
                    <input class="form-control" @bind="_itemBarcode" placeholder="RM-0001" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Physical Qty</label>
                    <input type="number" min="0" step="0.001" class="form-control" @bind="_physicalQty" />
                </div>
            </div>

            <div class="d-flex justify-content-end gap-2 mt-3">
                <button class="btn btn-outline-secondary" @onclick="BackAsync">Back</button>
                <button class="btn btn-primary" @onclick="SubmitAsync" disabled="@_isSubmitting">Submit</button>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public Guid Id { get; set; }

    private CycleCountDto? _cycleCount;
    private bool _isLoading;
    private bool _isSubmitting;
    private string _locationCode = string.Empty;
    private string _itemBarcode = string.Empty;
    private decimal _physicalQty;

    private int CountedLocations =>
        _cycleCount?.Lines
            .Where(x => x.CountedAt.HasValue)
            .Select(x => x.LocationId)
            .Distinct()
            .Count()
        ?? 0;

    private int TotalLocations =>
        _cycleCount?.LocationIds.Count > 0
            ? _cycleCount.LocationIds.Count
            : _cycleCount?.Lines.Select(x => x.LocationId).Distinct().Count() ?? 0;

    protected override async Task OnParametersSetAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        _isLoading = true;
        try
        {
            _cycleCount = await CycleCountsClient.GetCycleCountByIdAsync(Id);
        }
        catch (ApiException ex)
        {
            _cycleCount = null;
            ToastService.ShowError(ex.UserMessage);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SubmitAsync()
    {
        if (string.IsNullOrWhiteSpace(_locationCode) || string.IsNullOrWhiteSpace(_itemBarcode))
        {
            ToastService.ShowError("Location and item barcode are required.");
            return;
        }

        if (_physicalQty < 0m)
        {
            ToastService.ShowError("Physical quantity must be >= 0.");
            return;
        }

        _isSubmitting = true;
        try
        {
            var response = await CycleCountsClient.RecordCountAsync(Id, new RecordCountRequestDto
            {
                CommandId = Guid.NewGuid(),
                LocationCode = _locationCode.Trim(),
                ItemBarcode = _itemBarcode.Trim(),
                PhysicalQty = _physicalQty
            });

            _cycleCount = response.CycleCount;
            if (response.HasDiscrepancy && !string.IsNullOrWhiteSpace(response.Warning))
            {
                ToastService.ShowError(response.Warning);
            }
            else
            {
                ToastService.ShowSuccess($"Count recorded for {_locationCode.Trim()}.");
            }
        }
        catch (ApiException ex)
        {
            ToastService.ShowError(ex.UserMessage);
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private Task BackAsync()
    {
        NavigationManager.NavigateTo("/warehouse/cycle-counts");
        return Task.CompletedTask;
    }
}
