@page "/warehouse/outbound/pack/{OrderId:guid}"
@inject OutboundClient OutboundClient
@inject NavigationManager NavigationManager
@inject ToastService ToastService
@using LKvitai.MES.WebUI.Infrastructure

<PageTitle>Packing Station - LKvitai.MES</PageTitle>

<h1>Packing Station</h1>

@if (_apiError is not null)
{
    <ErrorBanner Message="@BuildErrorMessage(_apiError)"
                 TraceId="@_apiError.TraceId"
                 OnRetry="ReloadAsync"
                 OnDismiss="DismissError" />
}

<div class="card shadow-sm position-relative">
    <LoadingSpinner IsLoading="@(_isLoading || _isSubmitting)" />

    <div class="card-body">
        @if (_order is null && !_isLoading)
        {
            <p class="text-muted mb-0">Order not found.</p>
        }
        else if (_order is not null)
        {
            <div class="d-flex justify-content-between flex-wrap gap-2 mb-3">
                <div>
                    <h4 class="mb-1">@_order.OrderNumber</h4>
                    <div class="text-muted">Customer: @(_order.CustomerName ?? "-")</div>
                </div>
                <div>
                    <span class="badge @GetStatusBadgeClass(_order.Status)">@_order.Status</span>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-lg-7">
                    <h5>Order Items</h5>
                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Barcode</th>
                                    <th>Required</th>
                                    <th>Scanned</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var line in _order.Lines)
                                {
                                    var scannedQty = GetScannedQty(line);
                                    <tr>
                                        <td>@line.ItemSku</td>
                                        <td>@(line.PrimaryBarcode ?? "-")</td>
                                        <td>@line.Qty</td>
                                        <td>@scannedQty</td>
                                        <td>
                                            @if (scannedQty >= line.Qty)
                                            {
                                                <span class="badge bg-success">Ready</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">Pending</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="col-lg-5">
                    <h5>Packing Progress</h5>
                    <div class="mb-3">
                        <label class="form-label" for="barcode-input">Scan barcode</label>
                        <input id="barcode-input"
                               class="form-control"
                               type="text"
                               @bind="_barcodeInput"
                               @onkeydown="HandleBarcodeKeyDown"
                               autofocus />
                        <div class="form-text">Press Enter after each scan.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="packaging-type">Packaging type</label>
                        <select id="packaging-type" class="form-select" @bind="_packagingType">
                            <option value="BOX">BOX</option>
                            <option value="PALLET">PALLET</option>
                        </select>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(_scanError))
                    {
                        <div class="alert alert-warning py-2" role="alert">@_scanError</div>
                    }

                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-primary"
                                @onclick="PackAsync"
                                disabled="@(!CanPack || _isSubmitting)">
                            Pack
                        </button>
                        <button class="btn btn-outline-secondary" @onclick="ClearScans" disabled="isSubmitting">Clear Scans</button>
                        <button class="btn btn-outline-secondary" @onclick="BackToOrder" disabled="isSubmitting">Back</button>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public Guid OrderId { get; set; }

    private OutboundOrderDetailDto? _order;
    private bool _isLoading;
    private bool _isSubmitting;
    private ApiException? _apiError;
    private string _barcodeInput = string.Empty;
    private string _scanError = string.Empty;
    private string _packagingType = "BOX";

    private readonly Dictionary<string, decimal> _scanned = new(StringComparer.OrdinalIgnoreCase);

    protected override async Task OnParametersSetAsync()
    {
        await ReloadAsync();
    }

    private async Task ReloadAsync()
    {
        _isLoading = true;
        _apiError = null;

        try
        {
            _order = await OutboundClient.GetOutboundOrderAsync(OrderId);
        }
        catch (ApiException ex)
        {
            _apiError = ex;
            _order = null;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void DismissError()
    {
        _apiError = null;
    }

    private void HandleBarcodeKeyDown(KeyboardEventArgs args)
    {
        if (!string.Equals(args.Key, "Enter", StringComparison.Ordinal))
        {
            return;
        }

        ScanBarcode(_barcodeInput);
        _barcodeInput = string.Empty;
    }

    private void ScanBarcode(string rawBarcode)
    {
        _scanError = string.Empty;

        var barcode = rawBarcode.Trim();
        if (string.IsNullOrWhiteSpace(barcode))
        {
            return;
        }

        if (_order is null)
        {
            _scanError = "Order is not loaded.";
            return;
        }

        var matchingLine = _order.Lines.FirstOrDefault(line =>
            string.Equals(line.PrimaryBarcode, barcode, StringComparison.OrdinalIgnoreCase) ||
            string.Equals(line.ItemSku, barcode, StringComparison.OrdinalIgnoreCase));

        if (matchingLine is null)
        {
            _scanError = $"Barcode {barcode} not found in order.";
            return;
        }

        var key = ResolveScanKey(matchingLine, barcode);
        _scanned[key] = _scanned.TryGetValue(key, out var existing)
            ? existing + 1m
            : 1m;
    }

    private async Task PackAsync()
    {
        if (_order is null || !CanPack)
        {
            return;
        }

        _isSubmitting = true;
        _scanError = string.Empty;

        try
        {
            var scannedItems = _order.Lines
                .Select(line => new ScannedItemRequestDto
                {
                    Barcode = ResolveScanKey(line, line.PrimaryBarcode ?? line.ItemSku),
                    Qty = GetScannedQty(line)
                })
                .Where(item => item.Qty > 0)
                .ToList();

            await OutboundClient.PackOrderAsync(_order.Id, new PackOrderRequestDto
            {
                CommandId = Guid.NewGuid(),
                PackagingType = _packagingType,
                ScannedItems = scannedItems
            });

            ToastService.ShowSuccess("Order packed successfully.");
            NavigationManager.NavigateTo("/warehouse/outbound/dispatch");
        }
        catch (ApiException ex)
        {
            _apiError = ex;
            _scanError = BuildErrorMessage(ex);
            ToastService.ShowError(_scanError);
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private void ClearScans()
    {
        _scanned.Clear();
        _scanError = string.Empty;
    }

    private void BackToOrder()
    {
        NavigationManager.NavigateTo($"/warehouse/outbound/orders/{OrderId}");
    }

    private bool CanPack => _order is not null &&
                            _order.Lines.Count > 0 &&
                            _order.Lines.All(line => GetScannedQty(line) == line.Qty);

    private decimal GetScannedQty(OutboundOrderLineDto line)
    {
        if (_scanned.TryGetValue(ResolveScanKey(line, line.PrimaryBarcode ?? line.ItemSku), out var byPrimary))
        {
            return byPrimary;
        }

        return 0m;
    }

    private static string ResolveScanKey(OutboundOrderLineDto line, string fallback)
        => !string.IsNullOrWhiteSpace(line.PrimaryBarcode)
            ? line.PrimaryBarcode.Trim()
            : fallback.Trim();

    private static string BuildErrorMessage(ApiException ex)
        => !string.IsNullOrWhiteSpace(ex.UserMessage)
            ? ex.UserMessage
            : "Packing request failed.";

    private static string GetStatusBadgeClass(string status)
        => status.ToUpperInvariant() switch
        {
            "ALLOCATED" => "bg-info text-dark",
            "PICKING" => "bg-primary",
            "PICKED" => "bg-secondary",
            "PACKED" => "bg-warning text-dark",
            "SHIPPED" => "bg-success",
            "DELIVERED" => "bg-success",
            "CANCELLED" => "bg-danger",
            _ => "bg-light text-dark"
        };
}
