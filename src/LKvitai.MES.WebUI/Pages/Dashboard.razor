@page "/dashboard"
@implements IDisposable
@inject DashboardClient DashboardClient
@inject IConfiguration Configuration
@using System.Diagnostics

<PageTitle>Dashboard - LKvitai.MES</PageTitle>

<h3>Dashboard</h3>

@if (_pageError is not null)
{
    <ErrorBanner Message="@BuildErrorMessage(_pageError)"
                 TraceId="@_pageError.TraceId"
                 OnRetry="RetryAllAsync"
                 OnDismiss="DismissPageError" />
}

<div class="row g-3">
    <div class="col-12 col-xl-6">
        <HealthStatusCard Data="@_health.Data"
                          IsLoading="@_health.IsLoading"
                          ErrorMessage="@BuildErrorMessage(_health.Error)"
                          TraceId="@_health.Error?.TraceId"
                          OnRetry="LoadHealthAsync"
                          OnDismiss="@(() => DismissCardError(_health))" />
    </div>

    <div class="col-12 col-xl-6">
        <StockSummaryCard Data="@_stockSummary.Data"
                          IsLoading="@_stockSummary.IsLoading"
                          ErrorMessage="@BuildErrorMessage(_stockSummary.Error)"
                          TraceId="@_stockSummary.Error?.TraceId"
                          OnRetry="LoadStockSummaryAsync"
                          OnDismiss="@(() => DismissCardError(_stockSummary))" />
    </div>

    <div class="col-12 col-xl-6">
        <ReservationSummaryCard Data="@_reservationSummary.Data"
                                IsLoading="@_reservationSummary.IsLoading"
                                ErrorMessage="@BuildErrorMessage(_reservationSummary.Error)"
                                TraceId="@_reservationSummary.Error?.TraceId"
                                OnRetry="LoadReservationSummaryAsync"
                                OnDismiss="@(() => DismissCardError(_reservationSummary))" />
    </div>

    <div class="col-12 col-xl-6">
        <ProjectionHealthCard Data="@_projectionHealth.Data"
                              IsLoading="@_projectionHealth.IsLoading"
                              ErrorMessage="@BuildErrorMessage(_projectionHealth.Error)"
                              TraceId="@_projectionHealth.Error?.TraceId"
                              OnRetry="LoadProjectionHealthAsync"
                              OnDismiss="@(() => DismissCardError(_projectionHealth))" />
    </div>

    <div class="col-12">
        <RecentActivityFeed Items="@_recentActivity.Data"
                            IsLoading="@_recentActivity.IsLoading"
                            ErrorMessage="@BuildErrorMessage(_recentActivity.Error)"
                            TraceId="@_recentActivity.Error?.TraceId"
                            OnRetry="LoadRecentActivityAsync"
                            OnDismiss="@(() => DismissCardError(_recentActivity))" />
    </div>
</div>

@code {
    private readonly CardState<HealthStatusDto> _health = new();
    private readonly CardState<StockSummaryDto> _stockSummary = new();
    private readonly CardState<ReservationSummaryDto> _reservationSummary = new();
    private readonly CardState<ProjectionHealthDto> _projectionHealth = new();
    private readonly CardState<IReadOnlyList<RecentMovementDto>> _recentActivity = new(Array.Empty<RecentMovementDto>());

    private readonly SemaphoreSlim _loadLock = new(1, 1);
    private Timer? _refreshTimer;
    private ApiException? _pageError;
    private int _refreshIntervalSeconds = 30;

    protected override async Task OnInitializedAsync()
    {
        _refreshIntervalSeconds = Math.Max(5, Configuration.GetValue<int?>("RefreshIntervals:DashboardSeconds") ?? 30);

        await LoadAllAsync();

        _refreshTimer = new Timer(
            _ => _ = InvokeAsync(LoadAllAsync),
            null,
            TimeSpan.FromSeconds(_refreshIntervalSeconds),
            TimeSpan.FromSeconds(_refreshIntervalSeconds));
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
        _loadLock.Dispose();
    }

    private async Task RetryAllAsync()
    {
        _pageError = null;
        await LoadAllAsync();
    }

    private Task LoadHealthAsync() => LoadSingleCardAsync(_health, () => DashboardClient.GetHealthAsync());

    private Task LoadStockSummaryAsync() => LoadSingleCardAsync(_stockSummary, () => DashboardClient.GetStockSummaryAsync());

    private Task LoadReservationSummaryAsync()
        => LoadSingleCardAsync(_reservationSummary, () => DashboardClient.GetReservationSummaryAsync());

    private Task LoadProjectionHealthAsync()
        => LoadSingleCardAsync(_projectionHealth, () => DashboardClient.GetProjectionHealthAsync());

    private Task LoadRecentActivityAsync()
        => LoadSingleCardAsync(_recentActivity, () => DashboardClient.GetRecentActivityAsync(10));

    private async Task LoadAllAsync()
    {
        await _loadLock.WaitAsync();

        try
        {
            _pageError = null;

            await Task.WhenAll(
                LoadSingleCardAsync(_health, () => DashboardClient.GetHealthAsync(), suppressStateChange: true),
                LoadSingleCardAsync(_stockSummary, () => DashboardClient.GetStockSummaryAsync(), suppressStateChange: true),
                LoadSingleCardAsync(_reservationSummary, () => DashboardClient.GetReservationSummaryAsync(), suppressStateChange: true),
                LoadSingleCardAsync(_projectionHealth, () => DashboardClient.GetProjectionHealthAsync(), suppressStateChange: true),
                LoadSingleCardAsync(_recentActivity, () => DashboardClient.GetRecentActivityAsync(10), suppressStateChange: true));

            var errors = new[]
            {
                _health.Error,
                _stockSummary.Error,
                _reservationSummary.Error,
                _projectionHealth.Error,
                _recentActivity.Error
            }
            .Where(error => error is not null)
            .Cast<ApiException>()
            .ToList();

            if (errors.Count == 5)
            {
                _pageError = errors.FirstOrDefault(error => error.StatusCode == 503);
            }
        }
        finally
        {
            _loadLock.Release();
            StateHasChanged();
        }
    }

    private async Task LoadSingleCardAsync<T>(
        CardState<T> state,
        Func<Task<T>> loader,
        bool suppressStateChange = false)
    {
        state.IsLoading = true;
        state.Error = null;

        try
        {
            state.Data = await loader();
        }
        catch (ApiException ex)
        {
            state.Data = default;
            state.Error = ex;
        }
        catch (Exception ex)
        {
            state.Data = default;
            state.Error = new ApiException(
                new ProblemDetailsModel
                {
                    Title = "Dashboard request failed",
                    Detail = ex.Message,
                    Status = 500,
                    TraceId = Activity.Current?.Id
                },
                500);
        }
        finally
        {
            state.IsLoading = false;

            if (!suppressStateChange)
            {
                StateHasChanged();
            }
        }
    }

    private void DismissPageError() => _pageError = null;

    private static void DismissCardError<T>(CardState<T> state)
    {
        state.Error = null;
    }

    private static string? BuildErrorMessage(ApiException? error)
    {
        if (error is null)
        {
            return null;
        }

        var title = error.ProblemDetails?.Title;
        var detail = error.ProblemDetails?.Detail;

        if (string.IsNullOrWhiteSpace(detail))
        {
            return string.IsNullOrWhiteSpace(title)
                ? error.UserMessage
                : $"{error.UserMessage} {title}";
        }

        return $"{error.UserMessage} {detail}";
    }

    private sealed class CardState<T>
    {
        public CardState()
        {
        }

        public CardState(T initialData)
        {
            Data = initialData;
        }

        public T? Data { get; set; }
        public bool IsLoading { get; set; }
        public ApiException? Error { get; set; }
    }
}
