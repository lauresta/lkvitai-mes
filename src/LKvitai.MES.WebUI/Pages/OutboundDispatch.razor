@page "/warehouse/outbound/dispatch"
@inject OutboundClient OutboundClient
@inject ToastService ToastService
@using LKvitai.MES.WebUI.Infrastructure

<PageTitle>Dispatch Confirmation - LKvitai.MES</PageTitle>

<h1>Dispatch Confirmation</h1>

@if (_apiError is not null)
{
    <ErrorBanner Message="@BuildErrorMessage(_apiError)"
                 TraceId="@_apiError.TraceId"
                 OnRetry="ReloadAsync"
                 OnDismiss="DismissError" />
}

<div class="card shadow-sm position-relative">
    <LoadingSpinner IsLoading="@(_isLoading || _isSubmitting)" />

    <div class="card-body">
        <div class="d-flex gap-2 mb-3">
            <button class="btn btn-outline-secondary" @onclick="ReloadAsync" disabled="@(_isLoading || _isSubmitting)">Refresh</button>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>Shipment Number</th>
                        <th>Order Number</th>
                        <th>Customer</th>
                        <th>Packed At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (_shipments.Count == 0)
                    {
                        <tr>
                            <td colspan="5" class="text-center text-muted py-4">No packed shipments available.</td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var shipment in _shipments)
                        {
                            <tr>
                                <td>@shipment.ShipmentNumber</td>
                                <td>@shipment.OutboundOrderNumber</td>
                                <td>@(shipment.CustomerName ?? "-")</td>
                                <td>@FormatDate(shipment.PackedAt)</td>
                                <td>
                                    <button class="btn btn-sm btn-primary"
                                            @onclick="() => OpenDispatchModal(shipment)"
                                            disabled="isSubmitting">
                                        Dispatch
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@if (_showModal && _selectedShipment is not null)
{
    <div class="modal fade show d-block" tabindex="-1" role="dialog" aria-modal="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Dispatch @_selectedShipment.ShipmentNumber</h5>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label" for="dispatch-carrier">Carrier</label>
                        <select id="dispatch-carrier" class="form-select" @bind="_carrier">
                            <option value="FEDEX">FEDEX</option>
                            <option value="UPS">UPS</option>
                            <option value="DHL">DHL</option>
                            <option value="USPS">USPS</option>
                            <option value="OTHER">OTHER</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="vehicle-id">Vehicle ID</label>
                        <input id="vehicle-id" class="form-control" type="text" @bind="_vehicleId" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal" disabled="isSubmitting">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="ConfirmDispatchAsync" disabled="isSubmitting">
                        Confirm Dispatch
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    private readonly List<ShipmentSummaryDto> _shipments = [];
    private bool _isLoading;
    private bool _isSubmitting;
    private ApiException? _apiError;
    private bool _showModal;
    private ShipmentSummaryDto? _selectedShipment;
    private string _carrier = "FEDEX";
    private string _vehicleId = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await ReloadAsync();
    }

    private async Task ReloadAsync()
    {
        _isLoading = true;
        _apiError = null;

        try
        {
            var rows = await OutboundClient.GetShipmentSummariesAsync("PACKED", null, null, null);
            _shipments.Clear();
            _shipments.AddRange(rows.OrderByDescending(x => x.PackedAt));
        }
        catch (ApiException ex)
        {
            _apiError = ex;
            ToastService.ShowError(BuildErrorMessage(ex));
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void DismissError()
    {
        _apiError = null;
    }

    private void OpenDispatchModal(ShipmentSummaryDto shipment)
    {
        _selectedShipment = shipment;
        _carrier = "FEDEX";
        _vehicleId = string.Empty;
        _showModal = true;
    }

    private void CloseModal()
    {
        _showModal = false;
        _selectedShipment = null;
    }

    private async Task ConfirmDispatchAsync()
    {
        if (_selectedShipment is null)
        {
            return;
        }

        _isSubmitting = true;

        try
        {
            await OutboundClient.DispatchShipmentAsync(_selectedShipment.Id, new DispatchShipmentRequestDto
            {
                CommandId = Guid.NewGuid(),
                Carrier = _carrier,
                VehicleId = string.IsNullOrWhiteSpace(_vehicleId) ? null : _vehicleId.Trim()
            });

            ToastService.ShowSuccess("Shipment dispatched successfully.");
            CloseModal();
            await ReloadAsync();
        }
        catch (ApiException ex)
        {
            _apiError = ex;
            ToastService.ShowError(BuildErrorMessage(ex));
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private static string BuildErrorMessage(ApiException ex)
        => !string.IsNullOrWhiteSpace(ex.UserMessage)
            ? ex.UserMessage
            : "Dispatch request failed.";

    private static string FormatDate(DateTimeOffset? value)
        => value.HasValue ? value.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm") : "-";
}
