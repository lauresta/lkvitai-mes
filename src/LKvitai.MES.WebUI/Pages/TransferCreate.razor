@page "/warehouse/transfers/create"
@inject TransfersClient TransfersClient
@inject MasterDataAdminClient MasterDataAdminClient
@inject NavigationManager NavigationManager
@inject ToastService ToastService

<PageTitle>Create Transfer - LKvitai.MES</PageTitle>

<h1>Create Transfer</h1>

@if (_apiError is not null)
{
    <ErrorBanner Message="@BuildErrorMessage(_apiError)"
                 TraceId="@_apiError.TraceId"
                 OnRetry="LoadLookupDataAsync"
                 OnDismiss="DismissError" />
}

<div class="card shadow-sm position-relative">
    <LoadingSpinner IsLoading="_isLoading || _isSubmitting" />

    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">From Warehouse</label>
                <input class="form-control" @bind="_fromWarehouse" placeholder="WH1" />
            </div>
            <div class="col-md-3">
                <label class="form-label">To Warehouse</label>
                <input class="form-control" @bind="_toWarehouse" placeholder="WH2 or SCRAP" />
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-outline-secondary" @onclick="BackToList">Back</button>
            </div>
        </div>

        <hr />

        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Transfer Lines</h5>
            <button class="btn btn-sm btn-outline-primary" @onclick="AddLine" disabled="@_isSubmitting">+ Add Line</button>
        </div>

        @if (_lines.Count == 0)
        {
            <EmptyState Title="No lines"
                        Message="Add at least one transfer line."
                        IconCss="bi bi-list-ul"
                        OnAction="AddLineAsync" />
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th style="width: 35%;">Item</th>
                            <th style="width: 15%;">Qty</th>
                            <th style="width: 20%;">From Location</th>
                            <th style="width: 20%;">To Location</th>
                            <th style="width: 10%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (var i = 0; i < _lines.Count; i++)
                        {
                            var line = _lines[i];
                            <tr>
                                <td>
                                    <select class="form-select" @bind="line.ItemId">
                                        <option value="">Select item</option>
                                        @foreach (var item in _items)
                                        {
                                            <option value="@item.Id">@item.InternalSKU - @item.Name</option>
                                        }
                                    </select>
                                </td>
                                <td>
                                    <input type="number" min="0.01" step="0.01" class="form-control" @bind="line.Qty" />
                                </td>
                                <td>
                                    <select class="form-select" @bind="line.FromLocationId">
                                        <option value="">From location</option>
                                        @foreach (var location in _locations)
                                        {
                                            <option value="@location.Id">@location.Code (@location.Type)</option>
                                        }
                                    </select>
                                </td>
                                <td>
                                    <select class="form-select" @bind="line.ToLocationId">
                                        <option value="">To location</option>
                                        @foreach (var location in _locations)
                                        {
                                            <option value="@location.Id">@location.Code (@location.Type)</option>
                                        }
                                    </select>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger"
                                            disabled="@(_isSubmitting || _lines.Count == 1)"
                                            @onclick="() => RemoveLine(i)">
                                        Remove
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        <div class="d-flex justify-content-end mt-3">
            <button class="btn btn-primary" @onclick="CreateAsync" disabled="@_isSubmitting">Create Transfer</button>
        </div>
    </div>
</div>

@code {
    private readonly List<AdminItemDto> _items = [];
    private readonly List<AdminLocationDto> _locations = [];
    private readonly List<TransferLineModel> _lines = [];

    private bool _isLoading;
    private bool _isSubmitting;
    private ApiException? _apiError;

    private string _fromWarehouse = "WH1";
    private string _toWarehouse = "WH2";

    protected override async Task OnInitializedAsync()
    {
        _lines.Add(new TransferLineModel());
        await LoadLookupDataAsync();
    }

    private async Task LoadLookupDataAsync()
    {
        _isLoading = true;
        _apiError = null;

        try
        {
            var items = await MasterDataAdminClient.GetItemsAsync(null, null, "Active", 1, 500);
            _items.Clear();
            _items.AddRange(items.Items);

            var locations = await MasterDataAdminClient.GetLocationsAsync(null, "Active", true, 1, 500);
            _locations.Clear();
            _locations.AddRange(locations.Items);
        }
        catch (ApiException ex)
        {
            _apiError = ex;
            ToastService.ShowError(BuildErrorMessage(ex));
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void AddLine()
    {
        _lines.Add(new TransferLineModel());
    }

    private Task AddLineAsync()
    {
        AddLine();
        return Task.CompletedTask;
    }

    private void RemoveLine(int index)
    {
        if (index < 0 || index >= _lines.Count || _lines.Count == 1)
        {
            return;
        }

        _lines.RemoveAt(index);
    }

    private async Task CreateAsync()
    {
        if (string.IsNullOrWhiteSpace(_fromWarehouse) || string.IsNullOrWhiteSpace(_toWarehouse))
        {
            ToastService.ShowError("From/To warehouse are required.");
            return;
        }

        if (string.Equals(_fromWarehouse.Trim(), _toWarehouse.Trim(), StringComparison.OrdinalIgnoreCase))
        {
            ToastService.ShowError("From warehouse and To warehouse must be different.");
            return;
        }

        var lines = _lines
            .Where(x => x.ItemId.HasValue && x.FromLocationId.HasValue && x.ToLocationId.HasValue && x.Qty > 0m)
            .Select(x => new TransferLineDto
            {
                ItemId = x.ItemId!.Value,
                Qty = x.Qty,
                FromLocationId = x.FromLocationId!.Value,
                ToLocationId = x.ToLocationId!.Value
            })
            .ToList();

        if (lines.Count == 0)
        {
            ToastService.ShowError("Add at least one valid transfer line.");
            return;
        }

        if (lines.Any(x => x.FromLocationId == x.ToLocationId))
        {
            ToastService.ShowError("Transfer line cannot move to same location.");
            return;
        }

        _isSubmitting = true;
        _apiError = null;

        try
        {
            var request = new CreateTransferRequestDto
            {
                CommandId = Guid.NewGuid(),
                FromWarehouse = _fromWarehouse.Trim(),
                ToWarehouse = _toWarehouse.Trim(),
                Lines = lines
            };

            var created = await TransfersClient.CreateTransferAsync(request);
            ToastService.ShowSuccess($"Transfer {created.TransferNumber} created.");
            NavigationManager.NavigateTo($"/warehouse/transfers/{created.Id}");
        }
        catch (ApiException ex)
        {
            _apiError = ex;
            ToastService.ShowError(BuildErrorMessage(ex));
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private void BackToList()
    {
        NavigationManager.NavigateTo("/warehouse/transfers");
    }

    private void DismissError()
    {
        _apiError = null;
    }

    private static string BuildErrorMessage(ApiException ex)
    {
        if (!string.IsNullOrWhiteSpace(ex.UserMessage))
        {
            return ex.UserMessage;
        }

        return ex.ProblemDetails?.Detail
               ?? ex.ProblemDetails?.Title
               ?? "Transfer request failed.";
    }

    private sealed class TransferLineModel
    {
        public int? ItemId { get; set; }
        public decimal Qty { get; set; } = 1m;
        public int? FromLocationId { get; set; }
        public int? ToLocationId { get; set; }
    }
}
