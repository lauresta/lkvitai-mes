name: deploy

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  docker-gated-integration-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x
      - name: Run docker-gated integration tests
        env:
          TESTCONTAINERS_ENABLED: "1"
        run: >
          dotnet test tests/Modules/Warehouse/LKvitai.MES.Tests.Warehouse.Integration/LKvitai.MES.Tests.Warehouse.Integration.csproj
          -v minimal
          --filter
          "FullyQualifiedName~ImportControllerIntegrationTests|FullyQualifiedName~ReceiveThenQcPass_ShouldMoveStockFromQcHoldToReceiving|FullyQualifiedName~ReceiveThenQcFail_ShouldMoveStockFromQcHoldToQuarantine|FullyQualifiedName~CreateAdjustment_ShouldUpdateProjectionAndBeVisibleInHistory|FullyQualifiedName~ProjectionInfrastructureIntegrationTests.Rebuild_OnFreshDatabase_ShouldSucceedWithoutShadowTableErrors|FullyQualifiedName~ProjectionIdempotencyIntegrationTests.ProjectionDaemon_ReprocessingWithoutNewEvents_ShouldNotDoubleStock"

  validate-schema:
    needs: docker-gated-integration-tests
    runs-on: ubuntu-latest
    env:
      WAREHOUSE_DB_CONNECTION: ${{ secrets.WAREHOUSE_DB_CONNECTION }}
    steps:
      - uses: actions/checkout@v4
      - name: Skip schema validation when secret is missing
        if: ${{ env.WAREHOUSE_DB_CONNECTION == '' }}
        run: echo "WAREHOUSE_DB_CONNECTION is not configured. Skipping schema validation."
      - name: Validate Marten schema
        if: ${{ env.WAREHOUSE_DB_CONNECTION != '' }}
        run: scripts/validate-schema.sh
